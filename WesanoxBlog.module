<?php

namespace ProcessWire;

class WesanoxBlog extends WireData implements Module
{
    public static function getModuleInfo()
    {
        return array(
            'title' => 'wesanox Blog Tool',
            'summary' => 'A little News Tool for Processwire made by wesanox.',
            'version' => '0.9.1',
            'author' => 'Frittenfritze',
            'icon' => 'newspaper-o',
            'autoload' => true,
            'installs' => ['ProcessWesanoxBlog', 'FieldtypeDynamicOptions','WesanoxMatrixContent','WesanoxMatrixBasic'],
            'requires' => array(
                'ProcessWire>=3.0.210',
                'PHP>=8.0.0',
                'WesanoxMatrixContent>=0.0.1',
                'WesanoxMatrixBasic>=0.0.1',
            ),
        );
    }

    /**
     * @var array|string[]
     */
    protected array $external_modules = [
//        'WesanoxMatrixContent' => 'https://github.com/wesanox/WesanoxMatrixContent/archive/refs/heads/main.zip',
//        'WesanoxMatrixBasic' => 'https://github.com/wesanox/WesanoxMatrixBasic/archive/refs/heads/main.zip',
        'FieldtypeDynamicOptions' => 'https://github.com/Toutouwai/FieldtypeDynamicOptions/archive/master.zip'
    ];

    /**
     * @var Module|_Module|null $helper_classes
     * @var Module|_Module|null $helper_fields
     */
    protected Module|_Module|null $helper_fields;
    protected Module|_Module|null $helper_classes;

    /**
     * @var array $fields_array
     */
    protected array $fields_array = [];

    /**
     * @var array|string[]
     */
    protected array $template_news = [
        'news'
    ];

    protected array $options_news = [
        'options_news'
    ];

    protected array $options_generals = [
        'options_generals'
    ];

    /**
     * @var array $matrix_basic_items
     */
    protected array $matrix_basic_items = [
        'basic_teaser_news',
        'basic_search_news'
    ];


    /**
     * @throws WirePermissionException
     */
    public function __construct()
    {
        parent::__construct();

        $this->helper_classes = $this->modules->get('WesanoxHelperClasses');
        $this->helper_fields = $this->modules->get('WesanoxHelperFields');

        $this->fields_array = include $this->config->paths->WesanoxBlog . 'config/fields.php';
    }

    /**
     * install function for the module
     *
     * @return void
     * @throws WirePermissionException
     * @throws WireException
     */
    public function ___install()
    {
        /**
         * Install external modules
         */
        foreach ($this->external_modules as $module_name => $module_url) {
            if (!$this->modules->isInstalled($module_name)) {
                $message = $this->helper_classes->downloadInstall($module_name, $module_url);
                if ($message !== true) $this->error($message);
            }
        }

        /**
         * create fields
         */
        foreach ($this->fields_array as $field_array) {
            $this->helper_fields->createFields($field_array);
        }

        /**
         * add Matrix item and copy item files
         */
        $this->addMatrixItem($this->fields);

        /**
         * create / copy the template_news.php in the templates folder
         */
        foreach($this->template_news as $template_news)
        {
            /**
             * Copy template files to the templates folder
             */
            $file = $this->config->paths->WesanoxBlog . 'src/templates/template_' .  $template_news . '.php';
            $file_target = $this->config->paths->templates . 'template_' . $template_news . '.php';

            if (!is_file($file_target)) {
                $this->files->copy($file, $file_target);
            }

            /**
             * Copy matrix files to the templates folder
             */
            $this->installMatrixBasicFiles(true);


            /**
             * @TODO we need individual templates settings for the fields (headline, text)
             *
             * if not exists, create content only Page
             */
            if ( !$this->templates->get('template_' . $template_news) ) {
                $fg = new Fieldgroup();
                $fg->name = 'template_' . $template_news;
                $fg->add('title');
                $fg->add('dynamic_categories_news');
                $fg->add('dynamic_subcategories_news');
                $fg->add('date_news');

                $fg->add('image');
//            $fg->get('image')->set('columnWidth', 50);
//            $fg->get('image')->save();

                $fg->add('text');
//            $fg->get('text')->set('columnWidth', 50);
//            $fg->get('text')->set('label', 'Kurzbeschreibung');
//            $fg->get('text')->save();

                $fg->add('matrix_content');
                $fg->save();

                $t = new Template();
                $t->name = 'template_' . $template_news;
                $t->label = 'News';
                $t->fieldgroup = $fg;
                $t->icon = 'Newspaper-o';
                $t->tags = 'Templates';
                $t->save();
            } else {
                $t = $this->templates->get('template_' . $template_news);

                $fg = $t->fieldgroup;
                $fg->add('dynamic_categories_news');
                $fg->add('dynamic_subcategories_news');
                $fg->add('date_news');

                $fg->add('image');
//            $tn->get('image')->set('columnWidth', 50);
//            $tn->get('image')->save();

                $fg->add('text');
//            $tn->get('text')->set('columnWidth', 50);
//            $tn->get('text')->set('label', 'Kurzbeschreibung');
//            $tn->get('text')->save();

                $fg->add('matrix_content');
                $fg->save();

                $t->fieldgroup = $fg;
                $t->save();
            }
        }

        foreach($this->options_generals as $options_generals)
        {
            /**
             * if not exists, create settings Page
             */
            if ( !$this->templates->get($options_generals) ) {
                $op = new Template();
                $op->name = $options_generals;
                $op->label = 'Einstellungen';
                $op->fieldgroup = $fg;
                $op->icon = 'cogs';
                $op->tags = 'Options';
                $op->noParents = -1;
                $op->save();
            }
        }

        foreach($this->options_news as $options_news)
        {
            /**
             * if not exists, create settings news Page or add new Fields
             * to the settingsnewspage
             */
            if ( !$this->templates->get($options_news) ) {
                $fg = new Fieldgroup();
                $fg->name = $options_news;
                $fg->add('title');
                $fg->add('matrix_basic');
                $fg->add('tab_news');
                $fg->add('repeater_categories_news');
                $fg->add('repeater_subcategories_news');
                $fg->add('tab_news_END');
                $fg->save();

                $t = new Template();
                $t->name = $options_news;
                $t->label = 'News Einstellungen';
                $t->fieldgroup = $fg;
                $t->icon = 'cogs';
                $t->tags = 'Options';
                $t->noParents = -1;
                $t->save();
            } else {
                $t = $this->templates->get($options_news);

                $fg = $t->fieldgroup;
                $fg->add('matrix_basic');
                $fg->add('tab_news');
                $fg->add('repeater_categories_news');
                $fg->add('repeater_subcategories_news');
                $fg->add('tab_news_END');
                $fg->save();

                $t->fieldgroup = $fg;
                $t->save();
            }

            $np = new Page();
            $np->template = $options_news;
            $np->parent = $this->pages->get('template=options_generals');
            $np->title = 'News Einstellungen';
            $np->name = 'options-news';
            $np->save();
        }
    }

    /**
     * uninstall function for the modul
     *
     * @return void
     * @throws WireException
     */
    public function ___uninstall()
    {
        /**
         * remove the settings page
         */
        if($this->pages->get('name=options-news')) {
            $this->pages->get('name=options-news')->delete();
        }

        /**
         * remove fields from news page
         */
        foreach($this->template_news as $template_news)
        {
            /**
             * delete template files
             */
            $file = $this->config->paths->templates . 'template=template_' . $template_news . '.php';

            if (is_file($file)) {
                $this->files->unlink($file);
            }

            $p = $this->pages->get('template=template_' . $template_news);
            $p->delete();

            if($this->templates->get('template_' . $template_news)) {
                $fg = $this->fieldgroups->get('template_' . $template_news);
                $fg->deleteAll();
                $fg->save();

                $this->templates->delete($this->templates->get('template_' . $template_news));
            }
        }

        foreach ($this->options_news as $options_news)
        {
            /**
             * delete template files
             */
            if($this->templates->get($options_news)) {
                $fg = $this->fieldgroups->get($options_news);
                $fg->deleteAll();
                $fg->save();

                $this->templates->delete($this->templates->get($options_news));
            }
        }

        /**
         * delete fields
         */
        $this->helper_fields->deleteFields($this->fields_array, 'matrix_basic', $this->matrix_basic_items);
    }

    /**
     * init function for the module
     *
     * @return void
     * @throws WireException
     */
    public function init():void
    {
        $this->addHookAfter('FieldtypeDynamicOptions::getSelectableOptions', $this, 'provideDynamicCategoriesNews');
        $this->addHookAfter('FieldtypeDynamicOptions::getSelectableOptions', $this, 'provideDynamicSubcategoriesNews');

        $this->ajaxLoadmore();
        $this->ajaxSearch();
    }

    /**
     * @param HookEvent $event
     * @return void
     */
    public function provideDynamicCategoriesNews(HookEvent $event) : void
    {
        $field = $event->arguments(1);

        if ($field->name === 'dynamic_categories_news') {
            foreach($this->options_news as $options_news) {
                $settingsPage = $this->pages->get('template=' . $options_news);
                $options = [];

                if($settingsPage->repeater_categories_news) {
                    foreach ($settingsPage->repeater_categories_news as $cat) {
                        $options[$cat->headline] = $cat->headline;
                    }
                }

                $event->return = $options;
            }
        }
    }

    /**
     * @param HookEvent $event
     * @return void
     */
    public function provideDynamicSubcategoriesNews(HookEvent $event) : void
    {
        $field = $event->arguments(1);

        if ($field->name === 'dynamic_subcategories_news') {
            foreach($this->options_news as $options_news) {
                $settingsPage = $this->pages->get('template=' . $options_news);
                $options = [];

                if ($settingsPage->repeater_subcategories_news) {
                    foreach ($settingsPage->repeater_subcategories_news as $subcat) {
                        $options[$subcat->headline] = $subcat->headline;
                    }
                }

                $event->return = $options;
            }
        }
    }

    /**
     * @param $fields
     * @return void
     */
    private function addMatrixItem($fields): void
    {
        /**
         * Add new item to matrix_basic
         */
        if($fields->get('matrix_basic')) {
            $id_value = $fields->get('int_value')->id;
            $id_option = $fields->get('checkbox_slider_option')->id;
            $id_categories = $fields->get('dynamic_categories_news')->id;
            $id_subcategories = $fields->get('dynamic_subcategories_news')->id;

            $f = $fields->get('matrix_basic');

            $matrix_template = $f->type->getMatrixTemplate($f);

            $key_teaser = $this->helper_fields->getMatrixKey('matrix_basic') + 1;
            $key_search = $key_teaser + 1;

            $f->setArray([
                "matrix{$key_teaser}_name"   => 'basic_teaser_news',
                "matrix{$key_teaser}_label"  => 'News Teaser',
                "matrix{$key_teaser}_head"   => '{matrix_label} [• {matrix_summary}]',
                "matrix{$key_teaser}_fields" => [
                    0 => $id_value,
                    1 => $id_option,
                    2 => $id_categories,
                    3 => $id_subcategories,
                ],
                "matrix{$key_teaser}_sort"   => $key_teaser,
                "matrix{$key_search}_name"   => 'basic_search_news',
                "matrix{$key_search}_label"  => 'News Suche',
                "matrix{$key_search}_head"   => '{matrix_label} [• {matrix_summary}]',
                "matrix{$key_search}_fields" => [
                    0 => $id_value,
                ],
                "matrix{$key_search}_sort"   => $key_search,
            ]);

            $f->save();

            $matrix_template->fieldgroup->add('int_value');
            $matrix_template->fieldgroup->add('checkbox_slider_option');
            $matrix_template->fieldgroup->add('dynamic_categories_news');
            $matrix_template->fieldgroup->add('dynamic_subcategories_news');
            $matrix_template->fieldgroup->save();

            $matrix_template->save();
        }
    }

    /**
     * Kopiert Matrix-Basic-Dateien aus dem Modul nach /site/templates/fields/matrix_basic/
     *
     * @param bool $overwrite true = vorhandene Dateien überschreiben
     */
    private function installMatrixBasicFiles(bool $overwrite = false): void
    {
        // Quelle: ModulA (hier beispielhaft "WesanoxBlog")
        $srcBase = $this->config->paths->WesanoxBlog . 'src/fields/matrix_basic/';

        // Ziel: /site/templates/fields/matrix_basic/
        $tplPath   = $this->config->paths->templates;
        $fieldsDir = $tplPath . 'fields/';
        $dstBase   = $fieldsDir . 'matrix_basic/';

        // 1) Zielordner sicherstellen
        if(!is_dir($fieldsDir)) {
            $this->files->mkdir($fieldsDir, true);
        }
        if(!is_dir($dstBase)) {
            $this->files->mkdir($dstBase, true);
        }

        // 2) Für jedes Item den kompletten Ordner kopieren
        foreach((array) $this->matrix_basic_items as $item) {

            $srcDir = rtrim($srcBase . $item, '/') . '/';
            $dstDir = rtrim($dstBase . $item, '/') . '/';

            if(!is_dir($srcDir)) {
                $this->log->save('matrix-copy', "Quelle fehlt: {$srcDir}");
                continue;
            }

            // Zielordner anlegen
            if(!is_dir($dstDir)) {
                $this->files->mkdir($dstDir, true);
            }

            // Rekursiv kopieren
            $this->copyDirRecursive($srcDir, $dstDir, $overwrite);
            $this->log->save('matrix-copy', "Kopiert: {$srcDir} → {$dstDir}" . ($overwrite ? ' (overwrite)' : ''));
        }
    }

    /**
     * Rekursives Kopieren eines Verzeichnisses mit PW-Bordmitteln
     */
    private function copyDirRecursive(string $src, string $dst, bool $overwrite = false): void
    {
        $it = new \RecursiveIteratorIterator(
            new \RecursiveDirectoryIterator($src, \FilesystemIterator::SKIP_DOTS),
            \RecursiveIteratorIterator::SELF_FIRST
        );

        foreach($it as $node) {
            $relPath = substr($node->getPathname(), strlen($src)); // relativer Pfad ab $src
            $target  = $dst . $relPath;

            if($node->isDir()) {
                if(!is_dir($target)) {
                    $this->files->mkdir($target, true);
                }
                continue;
            }

            // Datei kopieren (ggf. überspringen, wenn vorhanden)
            if(is_file($target) && !$overwrite) continue;

            // $this->files->copy kann Dateien (und URLs) kopieren
            $ok = $this->files->copy($node->getPathname(), $target);
            if(!$ok) {
                $this->log->save('matrix-copy', "Fehler beim Kopieren: {$node->getPathname()} → {$target}");
            }
        }
    }

    /**
     * Load more function
     *
     * @return void
     * @throws WireException
     */
    public function ajaxLoadmore() {
        $this->addHook('/ajax/news/loadmore', function(HookEvent $event) {
            if(!$this->config->ajax) return;

            $html = '';

            $limit = (int) $this->input->post('limit');
            $category = (string) $this->input->post('category');
            $subcategory = (string) $this->input->post('subcategories');

            if($category != '') $category = ', dynamic_categories_news=' . $category;
            if($subcategory != '') $subcategory = ', dynamic_subcategories_news=' . $subcategory;

            $limit_max = count($this->pages->find('template=template_news,sort=date_news' . $category . $subcategory));

            foreach($this->pages->find('template=template_news,sort=date_news, limit=' . $limit . $category . $subcategory) as $news)
            {
                $html .= '
                    <div class="col-md-6 col-lg-4 p-3">
                        <a class="text-black h-100" href="' . $news->url . '" aria-label="Jetzt mehr erfahren über - ' . $news->title . '">
                            <div class="border h-100 p-3">
                                <div class="fs-3 fw-normal py-2">
                                    ' . $news->title . '
                                </div>
                                <small>' . $news->date_news . ' | ' . $news->dynamic_categories_news[0] . '</small>
                            </div>
                        </a>
                    </div>
                ';
            }

            $payload = [
                'limit_max' => $limit_max,
                'html' => $html
            ];

            header('Content-Type: application/json; charset=utf-8');
            $event->return = json_encode($payload);
        });
    }

    /**
     *
     *
     * @return void
     * @throws WireException
     */
    public function ajaxSearch() {
        $this->addHook('/ajax/news/search', function(HookEvent $event) {
            if(!$this->config->ajax) return;

            $html = '';

            $limit = (int) $this->input->post('limit');
            $category = (string) $this->input->post('category');
            $subcategory = (string) $this->input->post('subcategory');

            if($category != '') $category = ', dynamic_categories_news=' . $category;
            if($subcategory != '') $subcategory = ', dynamic_subcategories_news=' . $subcategory;

            $limit_max = count($this->pages->find('template=template_news,sort=date_news' . $category . $subcategory));

            if ($limit_max != 0) {
                foreach($this->pages->find('template=template_news,sort=date_news, limit=' . $limit . $category . $subcategory) as $news)
                {
                    $html .= '
                        <div class="col-md-6 col-lg-4 p-3">
                            <a class="text-black h-100" href="' . $news->url . '" aria-label="Jetzt mehr erfahren über - ' . $news->title . '">
                                <div class="border h-100 p-3">
                                    <div class="fs-3 fw-normal py-2">
                                        ' . $news->title . '
                                    </div>
                                    <small>' . $news->date_news . ' | ' . $news->dynamic_categories_news[0] . '</small>
                                </div>
                            </a>
                        </div>
                    ';
                }
            } else {
                $html .= '<div class="text-center h3 p-3">Leider kein Ergebnis für deine Suche</div>';
            }

            $payload = [
                'limit_max' => $limit_max,
                'html' => $html
            ];

            header('Content-Type: application/json; charset=utf-8');
            $event->return = json_encode($payload);
        });
    }
}